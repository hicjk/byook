@model SellerViewModel

<div class="joinBox">
    <h3 class="text-center mb-3">사업자 회원가입</h3>
    <form method="post" asp-controller="Member" asp-action="SellerRegister">
        <table>
            <tr>
                <td>
                    <input type="text" id="businessNumber" asp-for="Seller!.SellerId" placeholder="사업자 등록번호" />
                    <button type="button" id="findBusinessNumber" class="btnConfirm">중복 확인</button>
                    <input type="hidden" />
                </td>
            </tr>
            <tr>
                <td>
                    <input type="password" asp-for="Seller!.Password" placeholder="비밀번호" />
                    <p class="guide" style="display: none;">
                        <span class="case1">10자 이상 입력</span>
                        <span class="case2">영문/숫자/특수문자(공백 제외)만 허용하며, 2개 이상 조합</span>
                        <span class="case3">동일한 숫자 3개 이상 연속 사용 불가</span>
                    </p>
                </td>
            </tr>
            <tr>
                <td>
                    <input type="password" placeholder="비밀번호 확인" />
                    <p class="guide" style="display: none;">
                        <span class="case1">동일한 비밀번호를 입력하세요 </span>
                    </p>
                </td>
            </tr>
            <tr>
                <td>
                    <input type="text" id="address" asp-for="Seller!.Address" disabled />
                    <button type="button" id="findAddress" class="btnConfirm">주소 검색</button><br />
                    <input type="text" id="otherAddress" style="display: none;" class="mt-3" asp-for="OtherAddress" />
                </td>
            </tr>
            <tr>
                <td>
                    <input type="text" asp-for="Seller!.Name" placeholder="이름" />
                    <span></span>
                </td>
            </tr>
            <tr>
                <td>
                    <input type="text" asp-for="Seller!.PhoneNumber" placeholder="휴대폰 번호" />
                    <span></span>
                </td>
            </tr>
            <tr>
                <td>
                    <input class="btnJoin" style="border: 0" type="submit" value="가입하기" />
                    <span></span>
                </td>
            </tr>
        </table>
    </form>
</div>
@await Html.PartialAsync("~/Common/Modal.cshtml")

<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js" async></script>
<script async>
    let isBusinessCheck = false;
    
    document.getElementById("findAddress").addEventListener("click", function() {
        new daum.Postcode({
            oncomplete: function(data) {

                let address = "";

                if(data.userSelectedType === "R") {
                    address = data["roadAddress"];
                } else {
                    address = data["jibunAddress"];
                }

                document.getElementById("address").setAttribute("value", address);

                let otherAddress = document.getElementById("otherAddress");

                otherAddress.style.display = "block";
                otherAddress.focus();
            }
        }).open();
    });

    document.getElementById("findBusinessNumber").addEventListener("click", function() {
        let businessNumber = document.getElementById("businessNumber");

        let data = {
            "b_no": [businessNumber.value]
        };

        const serviceKey = "EH8ytX4Y%2BOJHqA4Usvxn9bZ62Pf2Ib2yS%2FOXoBFN7nvIUzzyF9wlFrNsMA7dxHb3AQR0Hfbga5ViBwB1S01kJA%3D%3D";

        $.ajax({
            url: "https://api.odcloud.kr/api/nts-businessman/v1/status?serviceKey=" + serviceKey,
            type: "POST",
            data: JSON.stringify(data),
            contentType: "application/json",
            accept: "application/json",
            success: function(response) {
                console.log(response);
                const businessStatus = response.data[0]["b_stt"];

                if(businessStatus === "") {
                    console.log("국세청에 등록되지 않은 사업자입니다.");

                    return;
                }

                IsRegistered(businessNumber.value);
            },
            error: function(error) {
                console.log(error.responseText);
            }
        });
    });

    function IsRegistered(businessNumber) {

        $.ajax({
            url: "/api/member/sellers",
            contentType: "application/json",
            accept: "application/json",
            data: {
                businessNumber
            },
            success: function(response) {
                console.log(response);
                if(response) {
                    console.log("이미 가입한 사업자입니다.");

                    return;
                }

                isBusinessCheck = true;

                showModal();
            },
            error: function(error) {
                console.dir(error);
            }
        })
    }
</script>